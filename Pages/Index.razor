@page "/"
@using NPOI.SS.UserModel
@using NPOI.XSSF.UserModel
@using System.IO


<title value="Index"></title>

<MudGrid>
    <MudItem xs="12">
        <MudPaper Class="d-flex align-center justify-center mud-width-full py-4">
            <h3>Interface Auxiliar de Reposição de Estoque </h3>
            <hr />
        </MudPaper>
    </MudItem>
    <MudItem xs="6">
        <MudPaper Class="d-flex align-center justify-center mud-width-full py-5">
            <InputFile id="fileInput" OnChange="GetFile" onloadstart="Progress" hidden single />

            <MudButton HtmlTag="label"
                       onchange="GetFile"
                       Variant="Variant.Filled"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Filled.CloudUpload"
                       for="fileInput">
                Buscar Arquivo Excel
            </MudButton>
        </MudPaper>

    </MudItem>
    <MudItem xs="6">

        <MudExpansionPanels Class="py-5">
            <MudExpansionPanel Text="Filtros e Configurações" MaxHeight="650">
                <MudPaper Class="align-self-start" Elevation="3" Style="margin-bottom: 7px;">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Align="Align.Center">Configurações da Lista</MudText>
                    <MudCheckBox @bind-Checked="@ConsumoZero" Label="Não considera Consumo Total igual a zero." Color="Color.Secondary" Style="margin-bottom: 10px;"></MudCheckBox>
                    <MudCheckBox @bind-Checked="@ReposicaoZero" Label="Não considera Reposição menor que zero." Color="Color.Secondary" Style="margin-bottom: 10px;"></MudCheckBox>
                    <MudNumericField @bind-Value="fatorReposicao" Label="Fator de Reposição" Variant="Variant.Outlined" Min="1" Max="30" Style="max-width: fit-content; margin-bottom: 20px; margin-left: 20px" />
                </MudPaper>

                <MudPaper Class="d-flex align-center justify-center mud-width-full py-5" Style="margin-bottom: 7px;">
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Último Movimento</MudText>
                        <MudDateRangePicker @ref="_picker" Label="Período Considerado" @bind-DateRange="_dateRange">
                            <PickerActions>
                                <MudButton Class="mr-auto align-self-start" OnClick="@(() => _picker.Clear())">Clear</MudButton>
                                <MudButton OnClick="@(() => _picker.Close(false))">Cancel</MudButton>
                                <MudButton Color="Color.Primary" OnClick="@(() => _picker.Close())">Ok</MudButton>
                            </PickerActions>
                        </MudDateRangePicker>
                    </MudItem>
                </MudPaper>
                <MudDivider />
                <MudPaper Class="d-flex align-center justify-center mud-width-full py-5">
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Dias de Estoque</MudText>
                        <MudSlider @bind-Value="diasDeEstoque" Step="1" Min="0" Max="15" Color="Color.Info">Valor: Entre 0 e @diasDeEstoque.ToString()</MudSlider>
                    </MudItem>
                </MudPaper>
                <MudPaper Class="d-flex align-center justify-center " Elevation="4" Style="margin-top: 7px; width: 100%;">
                    <MudItem xs="12" sm="6">

                        <MudButton HtmlTag="btn"
                                   Style="width: max-content; margin: 20px;"
                                   OnClick="AplicarFiltrosEConfiguracoes"
                                   Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Sharp.FilterAlt">
                            Aplicar Filtros e Configurações
                        </MudButton>
                    </MudItem>
                </MudPaper>

            </MudExpansionPanel>
        </MudExpansionPanels>

    </MudItem>
    <MudItem>

    </MudItem>
</MudGrid>

<hr />

@if (alert)
{
    <MudAlert Severity="Severity.Info" Elevation="10">A lista está vazia.</MudAlert>
}

@if (progress)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />

}
@if (filterList.Count() > 0)
{
    <MudPaper Class="pa-5 mx-auto" Style="min-width: min-content;" Elevation="15">
        <MudPaper>
            <TabPage repoList="@filterList" RowsPerPage="filterList.Count"></TabPage>
        </MudPaper>
    </MudPaper>
}

@code {
    private bool progress = false;
    private MemoryStream stream2;
    private ReposicaoEstoque repo;
    private List<ReposicaoEstoque> listRepo;
    private List<ReposicaoEstoque> filterList = new();   
    MudDateRangePicker _picker;
    public double diasDeEstoque = 0;
    DateRange _dateRange = new DateRange(DateTime.Now.AddDays(-5).Date, DateTime.Now.Date);
    private bool alert = false;

    private bool ConsumoZero { get; set; } = false;
    private bool ReposicaoZero { get; set; } = false;

    private bool ReposicaoMenorIgualZero { get; set; } = false;
    private int fatorReposicao = 1;

    protected override void OnInitialized() => listRepo = new();

    private void Progress()
    {
        progress = !progress;
    }


    public async Task GetFile(InputFileChangeEventArgs e) //get excel file
    {
        Progress();

        //https://docs.microsoft.com/en-us/aspnet/core/blazor/file-uploads?view=aspnetcore-5.0&pivots=webassembly
        //prepare filestream from uploaded file
        var stream1 = e.File.OpenReadStream();
        stream2 = new MemoryStream();
        await stream1.CopyToAsync(stream2);
        stream1.Close();
        //await using FileStream stream = new(path, FileMode.Create);
        //await e.File.OpenReadStream().CopyToAsync(stream);
        await ReadExcel();
    }

    private async Task<List<ReposicaoEstoque>> ReadExcel()
    {
        List<string> rowList = new List<string>();
        ISheet sheet;
        //using (var stream = new FileStream("Test.xlsx", FileMode.Open))
        using (stream2)
        {
            stream2.Position = 0;
            NPOI.XSSF.UserModel.XSSFWorkbook xssWorkbook = new XSSFWorkbook(stream2);
            sheet = xssWorkbook.GetSheetAt(0);
            IRow headerRow = sheet.GetRow(0);
            int cellCount = headerRow.LastCellNum;
           

            for (int i = (sheet.FirstRowNum + 4); i <= sheet.LastRowNum; i++) //+3
            {
                repo = new();
                IRow row = sheet.GetRow(i);
                if (row == null) continue;
                if (row.Cells.All(d => d.CellType == CellType.Blank)) continue;
                for (int j = row.FirstCellNum; j < cellCount; j++)
                {
                    if (row.GetCell(j) != null)
                    {
                        if (!string.IsNullOrEmpty(row.GetCell(j).ToString()) && !string.IsNullOrWhiteSpace(row.GetCell(j).ToString()))
                        {
                            if (j == 0) repo.CodigoMV = row.GetCell(j).ToString();
                            if (j == 1) repo.Medicamento = row.GetCell(j).ToString();
                            if (j == 2) repo.Unidade = row.GetCell(j).ToString();
                            if (j == 3) repo.UltimoMovimento = DateTime.Parse(row.GetCell(j).ToString());
                            if (j == 4) repo.ConsumoTotal = float.Parse(row.GetCell(j).ToString());
                            if (j == 6) repo.EstoqueAtual = float.Parse(row.GetCell(j).ToString());
                            if (j == 7) repo.DiasDeEstoque = int.Parse(row.GetCell(j).ToString());
                        }
                    }
                }
                listRepo.Add(repo);
            }
        }
        Progress();
        for (int i = 0; i < listRepo.Count; i++)
        {
            listRepo[i].Id = i;
        }

        filterList = listRepo.ToList();

       return listRepo;
    }

    private void AplicarFiltrosEConfiguracoes()
    {
        if (!filterList.Any() && !listRepo.Any()) return;

        filterList = listRepo.Where(d => d.DiasDeEstoque >= 0 && d.DiasDeEstoque <= diasDeEstoque).ToList();
        filterList = filterList.Where(u => u.UltimoMovimento >= _dateRange.Start && u.UltimoMovimento <= _dateRange.End).ToList();
        CalcularReposicao(filterList);
        filterList = ReordenarID(filterList);
        if (ConsumoZero) { filterList = filterList.Where(x => x.ConsumoTotal > 0.0f).ToList(); };
        if (ReposicaoZero) { filterList = filterList.Where(x => x.Reposicao >= 0).ToList(); };
        if (filterList.Count() == 0)
        {
            alert = true;
        }
        else
        {
            alert = false;
        }
        StateHasChanged();
    }

    private List<ReposicaoEstoque> ReordenarID(List<ReposicaoEstoque> list)
    {
        for (int i = 0; i < list.Count; i++)
        {
            list[i].Id = i;
        }
        return list;
    }

    private void CalcularReposicao(List<ReposicaoEstoque> list)
    {
        foreach (var item in list)
        {
            item.Reposicao = ((int)item.ConsumoTotal * fatorReposicao - (int)item.EstoqueAtual);
        }
    }

}
